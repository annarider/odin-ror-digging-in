<div class="post">
  <div class="post-header">
    <%= link_to user_path(@post.user) do %>
      <%= image_tag @post.user.profile_picture_url(size: 60), alt: "#{@post.user.name}'s profile picture", class: "profile-picture" %>
    <% end %>
    <h2><%= link_to @post.user.name, user_path(@post.user) %></h2>
  </div>

  <p><%= @post.content %></p>

  <% if @post.image %>
    <%= image_tag @post.image %>
  <% end %>

  <p>Posted on: <%= @post.created_at.strftime("%B %d, %Y at %I:%M %p") %></p>

  <!-- Likes Section -->
  <div class="likes">
    <p>
      <strong><%= @post.likes.count %></strong>
      <%= "like".pluralize(@post.likes.count) %>
    </p>

    <% if @post.likes.exists?(user: current_user) %>
      <!-- User has already liked this post - show unlike button -->
      <% user_like = @post.likes.find_by(user: current_user) %>
      <%= button_to "Unlike", like_path(user_like), method: :delete %>
    <% else %>
      <!-- User hasn't liked this post - show like button -->
      <%= button_to "Like", post_likes_path(@post), method: :post %>
    <% end %>
  </div>

  <!-- Comments Section -->
  <div class="comments">
    <h3>Comments (<%= @post.comments.count %>)</h3>

    <% @post.comments.select(&:persisted?).each do |comment| %>
      <div class="comment">
        <div class="comment-header">
          <%= link_to user_path(comment.user) do %>
            <%= image_tag comment.user.profile_picture_url(size: 40), alt: "#{comment.user.name}'s profile picture", class: "profile-picture-small" %>
          <% end %>
          <div class="comment-info">
            <p>
              <strong><%= link_to comment.user.name, user_path(comment.user) %></strong>
              <small>- <%= time_ago_in_words(comment.created_at) %> ago</small>
            </p>
          </div>
        </div>
        <p><%= comment.content %></p>

        <!-- Comment Likes -->
        <div class="comment-likes">
          <small>
            <strong><%= comment.likes.count %></strong> <%= "like".pluralize(comment.likes.count) %>
          </small>

          <% if comment.likes.exists?(user: current_user) %>
            <% user_like = comment.likes.find_by(user: current_user) %>
            <%= button_to "Unlike", like_path(user_like), method: :delete, class: "small-button" %>
          <% else %>
            <%= button_to "Like", comment_likes_path(comment), method: :post, class: "small-button" %>
          <% end %>

          <% if comment.user == current_user %>
            <%= button_to "Delete", comment_path(comment), method: :delete, form: { data: { turbo_confirm: "Delete this comment?" } }, class: "small-button" %>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- New Comment Form -->
    <h4>Add a comment</h4>
    <%= form_with model: [ @post, Comment.new ], url: post_comments_path(@post), local: true do |f| %>
      <div>
        <%= f.text_area :content, rows: 3, placeholder: "Write a comment...", required: true %>
      </div>
      <%= f.submit "Post Comment" %>
    <% end %>
  </div>

  <%= link_to 'See all posts', posts_path %>

  <% if @post.user == current_user %>
    <h3>Manage Post</h3>
    <%= link_to 'Edit Post', edit_post_path(@post) %>
    <%= button_to 'Delete Post', post_path(@post), method: :delete, form: { data: { turbo_confirm: 'Are you sure you want to delete this post?' } } %>
  <% end %>
</div>
